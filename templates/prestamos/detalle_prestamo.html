{% extends "base.html" %}

{% block title %}Detalle Préstamo - {{ block.super }}{% endblock %}

{% block page_title %}{{ titulo_pagina }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Información Principal del Préstamo -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-credit-card"></i> Información del Préstamo
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Número de Préstamo:</dt>
                            <dd class="col-sm-7"><strong><code>#{{ prestamo.numero_prestamo }}</code></strong></dd>
                            
                            <dt class="col-sm-5">Cliente:</dt>
                            <dd class="col-sm-7">{{ prestamo.cliente.nombre_completo }}</dd>
                            
                            <dt class="col-sm-5">Documento:</dt>
                            <dd class="col-sm-7">{{ prestamo.cliente.tipo_documento.nombre }}: {{ prestamo.cliente.numero_documento }}</dd>
                            
                            <dt class="col-sm-5">Número de Cuotas:</dt>
                            <dd class="col-sm-7">{{ prestamo.numero_cuotas }} {{ prestamo.get_frecuencia_pago_display }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Tasa de Interés:</dt>
                            <dd class="col-sm-7">{{ prestamo.tasa_interes.nombre }} ({{ prestamo.tasa_interes.valor_porcentaje }}%)</dd>
                            
                            <dt class="col-sm-5">Fecha de Emisión:</dt>
                            <dd class="col-sm-7">{{ prestamo.fecha_emision|date:"d/m/Y" }}</dd>
                            
                            <dt class="col-sm-5">Primer Pago:</dt>
                            <dd class="col-sm-7">{{ prestamo.fecha_primer_pago|date:"d/m/Y" }}</dd>
                            
                            <dt class="col-sm-5">Total Intereses:</dt>
                            <dd class="col-sm-7"><strong class="text-warning">S/ {{ total_intereses_real|floatformat:2 }}</strong></dd>
                            
                            <dt class="col-sm-5">Total a Pagar:</dt>
                            <dd class="col-sm-7"><strong class="text-success">S/ {{ monto_total_real|floatformat:2 }}</strong></dd>
                            
                            <dt class="col-sm-5">Estado:</dt>
                            <dd class="col-sm-7">
                                <span class="badge 
                                    {% if prestamo.estado == 'Pagado' %}bg-success
                                    {% elif prestamo.estado == 'En Atraso' %}bg-danger
                                    {% elif prestamo.estado == 'Activo' %}bg-primary
                                    {% else %}bg-secondary{% endif %} fs-6">
                                    {{ prestamo.get_estado_display }}
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if prestamo.garantia_descripcion %}
                <div class="mt-3">
                    <h6>Garantía:</h6>
                    <p class="text-muted">{{ prestamo.garantia_descripcion }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Plan de Pagos -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-check"></i> Plan de Pagos
                </h5>
                <span class="badge bg-info">{{ prestamo.plan_pagos.count }} cuotas</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Vencimiento</th>
                                <th class="text-end">Capital</th>
                                <th class="text-end">Interés</th>
                                <th class="text-end">Total Cuota</th>
                                <th class="text-end">Pagado</th>
                                <th class="text-end">Saldo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cuota in prestamo.plan_pagos.all %}
                            <tr class="{% if cuota.estado == 'Pagada' %}table-success{% elif cuota.estado == 'Vencida' %}table-danger{% elif cuota.estado == 'Pagada Parcialmente' %}table-warning{% endif %}">
                                <td><strong>{{ cuota.numero_cuota }}</strong></td>
                                <td>{{ cuota.fecha_vencimiento|date:"d/m/Y" }}</td>
                                <td class="text-end">S/ {{ cuota.monto_capital|floatformat:2 }}</td>
                                <td class="text-end">S/ {{ cuota.monto_interes|floatformat:2 }}</td>
                                <td class="text-end"><strong>S/ {{ cuota.monto_total_cuota|floatformat:2 }}</strong></td>
                                <td class="text-end">S/ {{ cuota.monto_pagado|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if cuota.saldo_pendiente > 0 %}
                                        <span class="text-danger">S/ {{ cuota.saldo_pendiente|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-success">S/ 0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if cuota.estado == 'Pagada' %}bg-success
                                        {% elif cuota.estado == 'Vencida' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ cuota.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Lateral -->
    <div class="col-lg-4">
        <!-- Resumen de Pagos -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Resumen de Pagos
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary">{{ prestamo.numero_cuotas }}</h4>
                            <small class="text-muted">Total Cuotas</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ cuotas_pagadas }}</h4>
                        <small class="text-muted">Cuotas Pagadas</small>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Total a Pagar:</span>
                    <strong class="text-primary">S/ {{ monto_total_real|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Total Pagado:</span>
                    <strong class="text-success">S/ {{ total_pagado|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Saldo Pendiente:</span>
                    {% if saldo_pendiente > 0 %}
                        <strong class="text-danger">S/ {{ saldo_pendiente|floatformat:2 }}</strong>
                    {% else %}
                        <strong class="text-success">S/ 0.00</strong>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Acciones -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Acciones
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if prestamo.estado == 'Activo' %}
                    <a href="{% url 'prestamos:registrar_pago' prestamo.id %}" class="btn btn-success">
                        <i class="bi bi-credit-card"></i> Registrar Pago
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'prestamos:lista_prestamos' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Volver a Lista
                    </a>
                </div>
            </div>
        </div>

        <!-- Información del Cliente -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-person"></i> Información del Cliente
                </h6>
            </div>
            <div class="card-body">
                <p><strong>Nombre:</strong> {{ prestamo.cliente.nombre_completo }}</p>
                <p><strong>Email:</strong> 
                    {% if prestamo.cliente.email %}
                        <a href="mailto:{{ prestamo.cliente.email }}">{{ prestamo.cliente.email }}</a>
                    {% else %}
                        <span class="text-muted">No registrado</span>
                    {% endif %}
                </p>
                <p><strong>Teléfono:</strong> 
                    {% if prestamo.cliente.telefono %}
                        {{ prestamo.cliente.telefono }}
                    {% else %}
                        <span class="text-muted">No registrado</span>
                    {% endif %}
                </p>
                
                {% if prestamo.cliente.direcciones.exists %}
                <h6 class="mt-3">Direcciones:</h6>
                {% for direccion in prestamo.cliente.direcciones.all %}
                <div class="small text-muted">
                    <strong>{{ direccion.distrito }}, {{ direccion.ciudad }}</strong><br>
                    {{ direccion.direccion_linea_1 }}
                    {% if direccion.es_principal %}<span class="badge bg-primary ms-1">Principal</span>{% endif %}
                </div>
                {% if not forloop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}
